<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ì‹ ì‚¬íŒ”ì‚¬íŒ”</title>
  <style>
    :root {
      --bg-color: #FFFFFF; --text-color: #37352F; --gray-text: #9B9A97;
      --dom-col-bg: #F7F6F3; --ovs-col-bg: #F0FDF4;
      --badge-gray-bg: #E3E2E0; --badge-green-bg: #DBEDDB;
      --tag-gray: #E3E2E0; --tag-brown: #EEE0DA; --tag-orange: #FADEC9;
      --tag-yellow: #FDECC8; --tag-green: #DBEDDB; --tag-blue: #D3E5EF;
      --tag-purple: #E8DEEE; --tag-pink: #F5E0E9; --tag-red: #FFE2DD;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-color); color: var(--text-color);
      margin: 0; padding: 20px; overflow-y: scroll; overflow-x: hidden;
    }

    /* ğŸ“± ëª¨ë°”ì¼ íƒ­ */
    .mobile-tabs { display: none; margin-bottom: 15px; gap: 10px; border-bottom: 1px solid #E9E9E7; padding-bottom: 10px; }
    .tab-btn { background: none; border: none; font-size: 0.95rem; color: var(--gray-text); cursor: pointer; padding: 5px 8px; }
    .tab-btn.active { color: var(--text-color); font-weight: 600; border-bottom: 2px solid var(--text-color); }

    /* ğŸ–¥ï¸ ë³´ë“œ ì»¨í…Œì´ë„ˆ */
    .board-container { display: flex; align-items: flex-start; gap: 16px; overflow-x: auto; padding-bottom: 20px; min-height: 80vh; }
    .column { flex: 0 0 280px; display: flex; flex-direction: column; border-radius: 6px; padding: 12px 10px; }
    #col-dom { background-color: var(--dom-col-bg); }
    #col-ovs { background-color: var(--ovs-col-bg); }

    .column-header { display: flex; align-items: center; margin-bottom: 10px; padding: 0 4px; height: 24px; }
    .header-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500; }
    .badge-dom { background: var(--badge-gray-bg); color: #32302C; }
    .badge-ovs { background: var(--badge-green-bg); color: #1C3829; }
    .count { margin-left: 6px; color: var(--gray-text); font-size: 0.8rem; }

    /* ğŸƒ ì¹´ë“œ */
    .card {
      background: white; border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); padding: 12px; margin-bottom: 8px;
      cursor: pointer; position: relative; transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
    .stock-title { font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; flex: 1; }
    .stock-icon { margin-right: 6px; font-size: 1rem; }

    .card-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
    .card:hover .card-actions { opacity: 1; }
    .action-btn { font-size: 0.8rem; padding: 2px 4px; border-radius: 3px; cursor: pointer; color: #888; background: rgba(0,0,0,0.05); border: none; }
    .action-btn:hover { background: #E0E0E0; color: #333; }
    .btn-del:hover { background: #FFE2DD; color: #D44C47; }

    .strategy-block { margin-bottom: 6px; font-size: 0.8rem; color: #37352F; }
    .strategy-label { color: var(--gray-text); font-size: 0.75rem; font-weight: 500; display: block; line-height: 1; margin-bottom: 2px !important; }
    .strategy-line { margin: 0 !important; margin-left: 5px !important; padding: 0 0 0 2px !important; line-height: 1.25 !important; display: block; word-break: break-all; white-space: pre-wrap; }
    .strategy-block div + div { margin-top: 1px !important; }

    .tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
    .tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; color: #444; }
    .tag-gray { background: var(--tag-gray); } .tag-brown { background: var(--tag-brown); } .tag-orange { background: var(--tag-orange); }
    .tag-yellow { background: var(--tag-yellow); } .tag-green { background: var(--tag-green); } .tag-blue { background: var(--tag-blue); }
    .tag-purple { background: var(--tag-purple); } .tag-pink { background: var(--tag-pink); } .tag-red { background: var(--tag-red); }

    .btn-new-page { display: flex; align-items: center; color: var(--gray-text); padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-top: 4px; }
    .btn-new-page:hover { background: rgba(0,0,0,0.05); color: var(--text-color); }
    .btn-new-page span { margin-right: 8px; font-size: 1.1rem; font-weight: 300; }

    /* â­ ì‚¬ì´ë“œ í”¼í¬ */
    .side-peek-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.3); z-index: 998;
    }
    .side-peek {
      position: fixed; top: 0; right: 0; width: 70%; height: 100%;
      background: white; box-shadow: -5px 0 30px rgba(0,0,0,0.1);
      z-index: 999; transform: translateX(100%); transition: transform 0.3s ease-out;
      display: flex; flex-direction: column;
    }
    .side-peek.open { transform: translateX(0); }

    .peek-header { padding: 20px 30px; border-bottom: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center; }
    .peek-title { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; }
    .peek-close { border: none; background: none; font-size: 1.5rem; cursor: pointer; color: #999; }

    .peek-content { padding: 0 30px 40px 30px; overflow-y: auto; flex: 1; }
    .peek-section { margin-top: 25px; }
    .peek-label { font-size: 0.85rem; color: #999; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center;}

    .peek-strategy-box { background: #FAFAFA; padding: 15px; border-radius: 6px; border: 1px solid #F0F0F0; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; }

    /* ë§¤ë§¤ ì¼ì§€ í†µê³„ */
    .trade-stats { display: flex; gap: 15px; margin-bottom: 15px; background: #F7F7F5; padding: 15px; border-radius: 8px; }
    .stat-item { flex: 1; }
    .stat-label { font-size: 0.75rem; color: #888; margin-bottom: 4px; }
    .stat-value { font-size: 1.1rem; font-weight: 700; color: #333; }
    .val-red { color: #E03E3E; } .val-blue { color: #2EAADC; }

    /* â­ ì…ë ¥ ë°•ìŠ¤ ë””ìì¸ (ìš”ì²­ì‚¬í•­ 2) */
    .trade-input-box {
      background: #FCFCFA; /* ì•„ì£¼ ì—°í•œ ë² ì´ì§€/íšŒìƒ‰ */
      border: 1px solid #E9E9E7;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .trade-input-header { font-size: 0.8rem; color: #999; margin-bottom: 10px; font-weight: 600; }

    .trade-input-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .trade-input { padding: 8px; border: 1px solid #DDD; border-radius: 4px; font-family: inherit; font-size: 0.9rem; background:white; }
    .btn-add-trade { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; white-space: nowrap;}

    .trade-list { list-style: none; padding: 0; margin: 0; }
    .trade-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #EEE; font-size: 0.9rem; }
    .trade-info { display: flex; flex-direction: column; gap: 2px; }
    .trade-meta { font-size: 0.75rem; color: #999; display: flex; gap: 6px; align-items: center;}
    .trade-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .badge-BUY { background: #FFE2DD; color: #D44C47; }
    .badge-SELL { background: #D3E5EF; color: #183347; }

    /* â­ ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-del-record {
      border: none; background: none; color: #CCC; cursor: pointer; font-size: 1.1rem; line-height: 1;
      padding: 0 0 0 8px; transition: color 0.2s;
    }
    .btn-del-record:hover { color: #E03E3E; }

    @media (max-width: 768px) {
      .mobile-tabs { display: flex; }
      .board-container { gap: 20px; scroll-snap-type: x mandatory; }
      .column { flex: 0 0 85vw; scroll-snap-align: start; }
      .card-actions { opacity: 1; }
      .side-peek { width: 90%; }
    }

    /* ëª¨ë‹¬ ë“± */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 92%; max-width: 500px; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
    .form-input, .form-textarea, .form-select { width: 100%; padding: 8px 0; border: none; border-bottom: 1px solid #E0E0E0; margin-bottom: 15px; font-size: 0.95rem; outline: none; font-family: inherit;}
    .form-textarea { resize: none; min-height: 80px; }
    .btn-submit { background: #333; color: white; width: 100%; padding: 10px; border-radius: 4px; border: none; cursor: pointer; margin-top: 10px; }
    .rec-tags-area { margin-top: 20px; padding-top: 15px; border-top: 1px solid #F0F0F0; }
    .rec-tag-btn { background: #F0F0F0; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin: 2px; cursor: pointer; color: #555; }
    .color-picker { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
    .color-opt { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-opt.selected { border: 2px solid #333; transform: scale(1.1); }

  </style>
</head>
<body>

<div class="mobile-tabs">
  <button class="tab-btn active" onclick="showColumn('ALL', this)">ì „ì²´ ë³´ê¸°</button>
  <button class="tab-btn" onclick="showColumn('DOM', this)">ğŸ‡°ğŸ‡· êµ­ì¥</button>
  <button class="tab-btn" onclick="showColumn('OVS', this)">ğŸ‡ºğŸ‡¸ ë¯¸ì¥</button>
</div>

<div class="board-container">
  <div id="col-dom" class="column">
    <div class="column-header"><div class="header-badge badge-dom">êµ­ì¥ ì „ëµ <span class="count" th:text="${#lists.size(stocks.?[marketType.name() == 'DOMESTIC'])}">0</span></div></div>
    <div class="card" th:each="stock : ${stocks}" th:if="${stock.marketType.name() == 'DOMESTIC'}" onclick="openSidePeek(this)" th:data-stock-id="${stock.id}" th:data-market="${stock.marketType}">
      <div class="hidden-data" style="display:none;">
        <div class="d-name" th:text="${stock.stockName}"></div>
        <div class="d-icon">ğŸ‡°ğŸ‡·</div>
        <div class="d-buy" th:each="s : ${stock.buyStrategies}" th:text="${s}"></div>
        <div class="d-sell" th:each="s : ${stock.sellStrategies}" th:text="${s}"></div>
        <div class="d-record" th:each="r : ${stock.records}" th:data-id="${r.id}" th:data-date="${r.tradingDate}" th:data-type="${r.type}" th:data-price="${r.price}" th:data-qty="${r.quantity}" th:data-memo="${r.memo}"></div>
      </div>
      <div class="card-header">
        <div class="stock-title"><span class="stock-icon">ğŸ‡°ğŸ‡·</span><span th:text="${stock.stockName}"></span></div>
        <div class="card-actions">
          <button class="action-btn" onclick="editStockDirect(event, this)">âœï¸</button>
          <button class="action-btn btn-del" onclick="deleteStockDirect(event, [[${stock.id}]])">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="strategy-block buy-area" th:if="${not #lists.isEmpty(stock.buyStrategies)}"><span class="strategy-label">&lt;ë§¤ìˆ˜&gt;</span><div class="strategy-line" th:each="st : ${stock.buyStrategies}" th:text="${st}"></div></div>
      <div class="strategy-block sell-area" th:if="${not #lists.isEmpty(stock.sellStrategies)}"><span class="strategy-label">&lt;ë§¤ë„&gt;</span><div class="strategy-line" th:each="st : ${stock.sellStrategies}" th:text="${st}"></div></div>
      <div class="tags"><span th:each="t : ${stock.tags}" th:with="p=${#strings.arraySplit(t, '|')}" class="tag" th:classappend="'tag-'+${p.length>1?p[1]:'gray'}" th:text="${p[0]}"></span></div>
    </div>
    <div class="btn-new-page" onclick="openCreateModal('DOMESTIC')"><span>+</span> ìƒˆ í˜ì´ì§€</div>
  </div>

  <div id="col-ovs" class="column">
    <div class="column-header"><div class="header-badge badge-ovs">ë¯¸ì¥ ì „ëµ <span class="count" th:text="${#lists.size(stocks.?[marketType.name() == 'OVERSEAS'])}">0</span></div></div>
    <div class="card" th:each="stock : ${stocks}" th:if="${stock.marketType.name() == 'OVERSEAS'}" onclick="openSidePeek(this)" th:data-stock-id="${stock.id}" th:data-market="${stock.marketType}">
      <div class="hidden-data" style="display:none;">
        <div class="d-name" th:text="${stock.stockName}"></div>
        <div class="d-icon">ğŸ‡ºğŸ‡¸</div>
        <div class="d-buy" th:each="s : ${stock.buyStrategies}" th:text="${s}"></div>
        <div class="d-sell" th:each="s : ${stock.sellStrategies}" th:text="${s}"></div>
        <div class="d-record" th:each="r : ${stock.records}" th:data-id="${r.id}" th:data-date="${r.tradingDate}" th:data-type="${r.type}" th:data-price="${r.price}" th:data-qty="${r.quantity}" th:data-memo="${r.memo}"></div>
      </div>
      <div class="card-header">
        <div class="stock-title"><span class="stock-icon">ğŸ‡ºğŸ‡¸</span><span th:text="${stock.stockName}"></span></div>
        <div class="card-actions">
          <button class="action-btn" onclick="editStockDirect(event, this)">âœï¸</button>
          <button class="action-btn btn-del" onclick="deleteStockDirect(event, [[${stock.id}]])">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="strategy-block buy-area" th:if="${not #lists.isEmpty(stock.buyStrategies)}"><span class="strategy-label">&lt;ë§¤ìˆ˜&gt;</span><div class="strategy-line" th:each="st : ${stock.buyStrategies}" th:text="${st}"></div></div>
      <div class="strategy-block sell-area" th:if="${not #lists.isEmpty(stock.sellStrategies)}"><span class="strategy-label">&lt;ë§¤ë„&gt;</span><div class="strategy-line" th:each="st : ${stock.sellStrategies}" th:text="${st}"></div></div>
      <div class="tags"><span th:each="t : ${stock.tags}" th:with="p=${#strings.arraySplit(t, '|')}" class="tag" th:classappend="'tag-'+${p.length>1?p[1]:'gray'}" th:text="${p[0]}"></span></div>
    </div>
    <div class="btn-new-page" onclick="openCreateModal('OVERSEAS')"><span>+</span> ìƒˆ í˜ì´ì§€</div>
  </div>
</div>

<div id="sidePeekOverlay" class="side-peek-overlay" onclick="closeSidePeek()"></div>
<div id="sidePeek" class="side-peek">
  <div class="peek-header">
    <div class="peek-title" id="peekTitle"></div>
    <button class="peek-close" onclick="closeSidePeek()">Ã—</button>
  </div>
  <div class="peek-content">
    <div class="peek-section">
      <div class="peek-label">ğŸ”¥ ë§¤ìˆ˜ ì „ëµ</div>
      <div id="peekBuy" class="peek-strategy-box"></div>
    </div>
    <div class="peek-section">
      <div class="peek-label">ğŸ’° ë§¤ë„ ì „ëµ</div>
      <div id="peekSell" class="peek-strategy-box"></div>
    </div>

    <div class="peek-section" style="border-top:1px solid #EEE; padding-top:20px;">
      <div class="peek-label">ğŸ“Š ë§¤ë§¤ ê¸°ë¡ & ìˆ˜ìµë¥  (ìë™ ê³„ì‚°)</div>
      <div class="trade-stats">
        <div class="stat-item"><div class="stat-label">ë³´ìœ  ìˆ˜ëŸ‰</div><div class="stat-value" id="statQty">0ì£¼</div></div>
        <div class="stat-item"><div class="stat-label">í‰ê·  ë‹¨ê°€</div><div class="stat-value" id="statAvg">0</div></div>
        <div class="stat-item"><div class="stat-label">ì‹¤í˜„ ì†ìµ</div><div class="stat-value" id="statProfit">0</div></div>
      </div>

      <div class="trade-input-box">
        <div class="trade-input-header">âœï¸ ê¸°ë¡ ì¶”ê°€</div>
        <div class="trade-input-row">
          <input type="date" id="tradeDate" class="trade-input" style="width:110px;">
          <select id="tradeType" class="trade-input">
            <option value="BUY">ë§¤ìˆ˜</option>
            <option value="SELL">ë§¤ë„</option>
          </select>
          <input type="number" id="tradePrice" class="trade-input" placeholder="ê°€ê²©" style="flex:1;">
          <input type="number" id="tradeQty" class="trade-input" placeholder="ìˆ˜ëŸ‰" style="width:60px;">
          <button class="btn-add-trade" onclick="addTradeRecord()">ë“±ë¡</button>
        </div>
        <input type="text" id="tradeMemo" class="trade-input" placeholder="ë©”ëª¨ (ex. í˜„ê¸ˆ í™•ë³´)" style="width:100%; box-sizing:border-box;">
      </div>

      <ul id="tradeList" class="trade-list"></ul>
    </div>
  </div>
</div>

<div id="createModal" class="modal-overlay" onclick="closeModal(event, 'createModal')">
  <div class="modal-box">
    <h3 id="modalTitle" style="margin-top:0;">í˜ì´ì§€ ì¶”ê°€</h3>
    <input type="hidden" id="inputId">
    <select id="inputMarket" class="form-select"><option value="DOMESTIC">êµ­ì¥</option><option value="OVERSEAS">ë¯¸ì¥</option></select>
    <input type="text" id="inputName" class="form-input" placeholder="ì œëª©">
    <input type="text" id="inputCode" class="form-input" placeholder="ì½”ë“œ">
    <textarea id="inputBuy" class="form-textarea" placeholder="ë§¤ìˆ˜ ì „ëµ"></textarea>
    <textarea id="inputSell" class="form-textarea" placeholder="ë§¤ë„ ì „ëµ"></textarea>
    <div style="margin-top:10px;"><input type="text" id="inputTagText" class="form-input" placeholder="íƒœê·¸" style="width:70%; display:inline-block;"><button onclick="addTagFromInput()" style="width:25%; padding:8px; border:1px solid #ddd; background:white;">ì¶”ê°€</button></div>
    <div class="color-picker">
      <div class="color-opt selected" style="background:#E3E2E0" onclick="selColor(this, 'gray')"></div>
      <div class="color-opt" style="background:#DBEDDB" onclick="selColor(this, 'green')"></div>
      <div class="color-opt" style="background:#D3E5EF" onclick="selColor(this, 'blue')"></div>
      <div class="color-opt" style="background:#FFE2DD" onclick="selColor(this, 'red')"></div>
    </div>
    <div id="curTags" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div>
    <div class="rec-tags-area">
      <div style="font-size:0.8rem; color:#999; margin-bottom:8px;">ğŸ·ï¸ ê¸°ì¡´ íƒœê·¸</div>
      <button th:each="fullTag : ${allTags}" th:with="parts=${#strings.arraySplit(fullTag, '|')}" class="rec-tag-btn" th:onclick="addTagFromRec([[${parts[0]}]], [[${parts[1]}]])"><span th:text="${parts[0]}"></span></button>
    </div>
    <button class="btn-submit" onclick="saveStock()">ì™„ë£Œ</button>
  </div>
</div>

<script>
  let curTags=[], selCol='gray';
  let currentStockId = null;
  let currentMarketType = 'DOMESTIC';

  // â­ 3. í˜ì´ì§€ ë¡œë“œ ì‹œ "ìë™ìœ¼ë¡œ ì°½ ì—´ê¸°" (ìƒíƒœ ìœ ì§€)
  window.onload = function() {
    const lastOpenId = localStorage.getItem('lastOpenStockId');
    if (lastOpenId) {
      const card = document.querySelector(`.card[data-stock-id="${lastOpenId}"]`);
      if (card) {
        openSidePeek(card); // ìë™ìœ¼ë¡œ í´ë¦­í•´ì¤Œ!
      }
      localStorage.removeItem('lastOpenStockId'); // í•  ì¼ ë‹¤ í–ˆìœ¼ë‹ˆ ì‚­ì œ
    }
  }

  function formatCurrency(val, type) {
    if(type === 'DOMESTIC') return 'â‚©' + Math.floor(val).toLocaleString();
    else return '$' + val.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 3});
  }

  function openSidePeek(cardEl) {
    const hiddenBox = cardEl.querySelector('.hidden-data');
    const name = hiddenBox.querySelector('.d-name').innerText;
    const icon = hiddenBox.querySelector('.d-icon').innerText;

    currentStockId = cardEl.getAttribute('data-stock-id');
    currentMarketType = cardEl.getAttribute('data-market');

    let buyText = ""; hiddenBox.querySelectorAll('.d-buy').forEach(d => buyText += "â€¢ " + d.innerText + "\n");
    let sellText = ""; hiddenBox.querySelectorAll('.d-sell').forEach(d => sellText += "â€¢ " + d.innerText + "\n");

    document.getElementById('peekTitle').innerHTML = `<span style="margin-right:10px;">${icon}</span> ${name}`;
    document.getElementById('peekBuy').innerText = buyText || "ì „ëµ ì—†ìŒ";
    document.getElementById('peekSell').innerText = sellText || "ì „ëµ ì—†ìŒ";
    document.getElementById('tradeDate').valueAsDate = new Date();

    const recordDivs = hiddenBox.querySelectorAll('.d-record');
    const records = [];
    recordDivs.forEach(div => {
      records.push({
        id: div.getAttribute('data-id'), // â­ ì‚­ì œë¥¼ ìœ„í•´ IDë„ ì½ìŒ
        date: div.getAttribute('data-date'),
        type: div.getAttribute('data-type'),
        price: parseFloat(div.getAttribute('data-price')),
        qty: parseInt(div.getAttribute('data-qty')),
        memo: div.getAttribute('data-memo')
      });
    });
    renderTradeLog(records);

    document.getElementById('sidePeekOverlay').style.display = 'block';
    setTimeout(() => { document.getElementById('sidePeek').classList.add('open'); }, 10);
  }

  function closeSidePeek() {
    document.getElementById('sidePeek').classList.remove('open');
    setTimeout(() => { document.getElementById('sidePeekOverlay').style.display = 'none'; }, 300);
  }

  function renderTradeLog(records) {
    const listEl = document.getElementById('tradeList');
    listEl.innerHTML = '';

    let totalQty = 0; let totalCost = 0; let realizedProfit = 0;

    if(records.length === 0) {
      listEl.innerHTML = '<li style="padding:15px; color:#999; text-align:center;">ì•„ì§ ë§¤ë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      updateStats(0, 0, 0); return;
    }

    records.sort((a, b) => new Date(a.date) - new Date(b.date));

    records.forEach(r => {
      if(r.type === 'BUY') { totalCost += r.price * r.qty; totalQty += r.qty; }
      else if(r.type === 'SELL') {
        const avgPrice = totalQty > 0 ? totalCost / totalQty : 0;
        realizedProfit += (r.price - avgPrice) * r.qty;
        const sellRatio = r.qty / totalQty;
        totalCost -= totalCost * sellRatio;
        totalQty -= r.qty;
      }

      const dateStr = r.date.substring(0, 10);
      const badgeClass = r.type === 'BUY' ? 'badge-BUY' : 'badge-SELL';
      const typeText = r.type === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
      const formattedPrice = formatCurrency(r.price, currentMarketType);

      const li = document.createElement('li');
      li.className = 'trade-item';
      li.innerHTML = `
                    <div class="trade-info">
                        <div style="font-weight:600;">
                            ${formattedPrice} <span style="color:#AAA; font-weight:400;">x</span> ${r.qty}ì£¼
                        </div>
                        <div style="font-size:0.8rem; color:#555;">${r.memo || '-'}</div>
                    </div>
                    <div class="trade-info" style="align-items:flex-end;">
                        <div>
                            <span class="trade-badge ${badgeClass}">${typeText}</span>
                            <button class="btn-del-record" onclick="deleteTradeRecord(${r.id})">Ã—</button>
                        </div>
                        <span class="trade-meta">${dateStr}</span>
                    </div>
                `;
      listEl.prepend(li);
    });

    const avgPrice = totalQty > 0 ? totalCost / totalQty : 0;
    updateStats(totalQty, avgPrice, realizedProfit);
  }

  function updateStats(qty, avg, profit) {
    document.getElementById('statQty').innerText = qty + "ì£¼";
    document.getElementById('statAvg').innerText = formatCurrency(avg, currentMarketType);
    const profitStr = formatCurrency(Math.abs(profit), currentMarketType);
    const profitEl = document.getElementById('statProfit');
    profitEl.innerText = (profit > 0 ? "+" : (profit < 0 ? "-" : "")) + profitStr;
    profitEl.className = "stat-value " + (profit >= 0 ? "val-red" : "val-blue");
  }

  function addTradeRecord() {
    if(!currentStockId) return;
    const date = document.getElementById('tradeDate').value;
    const type = document.getElementById('tradeType').value;
    const price = document.getElementById('tradePrice').value;
    const qty = document.getElementById('tradeQty').value;
    const memo = document.getElementById('tradeMemo').value;

    if(!date || !price || !qty) { alert('ë‚ ì§œ, ê°€ê²©, ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    const data = { date: date, type: type, price: parseFloat(price), quantity: parseInt(qty), memo: memo };

    fetch(`/api/stocks/${currentStockId}/records`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(r => {
      if(r.ok) {
        // â­ ì €ì¥ ì„±ê³µ ì‹œ, í˜„ì¬ ì—´ë ¤ìˆëŠ” ì¢…ëª© IDë¥¼ ì €ì¥í•´ë‘  (ìš”ì²­ì‚¬í•­ 3)
        localStorage.setItem('lastOpenStockId', currentStockId);
        location.reload();
      } else { alert('ì €ì¥ ì‹¤íŒ¨'); }
    });
  }

  // â­ ì‚­ì œ í•¨ìˆ˜
  function deleteTradeRecord(recordId) {
    if(!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    fetch(`/api/stocks/records/${recordId}`, { method: 'DELETE' }).then(r => {
      if(r.ok) {
        localStorage.setItem('lastOpenStockId', currentStockId); // ì‚­ì œ í›„ì—ë„ ì°½ ìœ ì§€
        location.reload();
      }
    });
  }

  // --- ê¸°íƒ€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ë³€í™” ì—†ìŒ) ---
  function showColumn(type, btn) {
    if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    const dom = document.getElementById('col-dom'), ovs = document.getElementById('col-ovs');
    if(window.innerWidth <= 768) {
      if(type==='ALL'){ dom.classList.remove('hidden','active'); ovs.classList.remove('hidden','active'); }
      else if(type==='DOM'){ dom.classList.remove('hidden'); dom.classList.add('active'); ovs.classList.add('hidden'); ovs.classList.remove('active'); }
      else { dom.classList.add('hidden'); dom.classList.remove('active'); ovs.classList.remove('hidden'); ovs.classList.add('active'); }
    }
  }
  function openCreateModal(type) {
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('inputId').value = '';
    document.getElementById('inputMarket').value = type;
    document.getElementById('inputName').value = '';
    document.getElementById('inputCode').value = '';
    document.getElementById('inputBuy').value = '';
    document.getElementById('inputSell').value = '';
    curTags = []; renderTags();
  }
  function editStockDirect(event, btn) {
    event.stopPropagation();
    const card = btn.closest('.card');
    const hiddenBox = card.querySelector('.hidden-data');
    const name = hiddenBox.querySelector('.d-name').innerText;
    const id = card.getAttribute('data-stock-id');
    let buyText = ""; hiddenBox.querySelectorAll('.d-buy').forEach(d => buyText += d.innerText + "\n");
    let sellText = ""; hiddenBox.querySelectorAll('.d-sell').forEach(d => sellText += d.innerText + "\n");
    curTags = [];
    card.querySelectorAll('.tags .tag').forEach(tag => {
      const text = tag.innerText;
      let color = 'gray';
      tag.classList.forEach(cls => { if(cls.startsWith('tag-')) color = cls.replace('tag-',''); });
      curTags.push(text + '|' + color);
    });
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = "í˜ì´ì§€ ìˆ˜ì •";
    document.getElementById('inputId').value = id;
    document.getElementById('inputName').value = name;
    document.getElementById('inputBuy').value = buyText;
    document.getElementById('inputSell').value = sellText;
    renderTags();
  }
  function deleteStockDirect(event, id) {
    event.stopPropagation();
    if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) fetch('/api/stocks/' + id, { method: 'DELETE' }).then(r => location.reload());
  }
  function saveStock() {
    const data = {
      id: document.getElementById('inputId').value || null,
      stockName: document.getElementById('inputName').value,
      code: document.getElementById('inputCode').value,
      marketType: document.getElementById('inputMarket').value,
      buyStrategies: document.getElementById('inputBuy').value.split('\n').filter(s=>s.trim()),
      sellStrategies: document.getElementById('inputSell').value.split('\n').filter(s=>s.trim()),
      tags: curTags
    };
    fetch('/api/stocks', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }).then(r=>{ if(r.ok) location.reload(); });
  }
  function closeModal(e, id) { if(e.target === document.getElementById(id)) document.getElementById(id).style.display='none'; }
  function selColor(el, c) { document.querySelectorAll('.color-opt').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); selCol = c; }
  function addTagFromInput() { let v = document.getElementById('inputTagText').value; if(v) { curTags.push(v+'|'+selCol); renderTags(); document.getElementById('inputTagText').value=''; } }
  function addTagFromRec(n, c) { curTags.push(n+'|'+c); renderTags(); }
  function renderTags() { const b = document.getElementById('curTags'); b.innerHTML=''; curTags.forEach((t,i)=>{ let p=t.split('|'); b.innerHTML+=`<span class="tag tag-${p[1]||'gray'}" onclick="curTags.splice(${i},1);renderTags()" style="cursor:pointer">${p[0]} âœ•</span>`; }); }
</script>
</body>
</html>