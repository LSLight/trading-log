<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Strategy</title>
  <style>
    :root { --bg: #FFF; --gray: #787774; --border: #E9E9E7; --dom-bg: #F7F6F3; --ovs-bg: #F2F8F2; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #37352F; margin: 0; padding: 20px; }

    /* íƒ­ ë° ë ˆì´ì•„ì›ƒ (ê¸°ì¡´ ë™ì¼) */
    .mobile-tabs { display: none; justify-content: center; margin-bottom: 20px; gap: 20px; }
    .tab-btn { border: none; background: none; font-size: 1rem; color: var(--gray); font-weight: 500; cursor: pointer; }
    .tab-btn.active { color: #37352F; font-weight: 700; border-bottom: 2px solid #37352F; }
    .main-container { display: flex; justify-content: center; align-items: flex-start; gap: 30px; max-width: 700px; margin: 0 auto; }
    .column { flex: 1; max-width: 500px; padding: 16px; border-radius: 8px; }
    .col-dom { background: var(--dom-bg); } .col-ovs { background: var(--ovs-bg); }
    .header { display: flex; align-items: center; margin-bottom: 15px; font-weight: 600; font-size: 0.95rem; }
    .badge { padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; }
    .badge-dom { background: #E3E2E0; color: #37352F; } .badge-ovs { background: #DBEDDB; color: #1C3829; }

    @media (max-width: 768px) {
      .mobile-tabs { display: flex; } .main-container { flex-direction: column; width: 100%; gap: 0; }
      .column { display: none; width: 100%; max-width: none; padding: 0; background: transparent; } .column.show { display: block; }
    }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card { background: white; border-radius: 6px; padding: 14px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); cursor: pointer; border: 1px solid rgba(0,0,0,0.02); }
    /*.card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }*/
    .card-top { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .stock-name { font-weight: 700; } .stock-code { font-size: 0.8rem; color: var(--gray); margin-left: 5px; }

    /* â­ ì „ëµ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ì  ì°ê¸°) */
    .strategy-list { margin: 5px 0; padding-left: 0; list-style: none; }
    .strategy-item { font-size: 0.85rem; color: #555; margin-bottom: 3px; display: flex; align-items: flex-start; }
    .bullet { margin-right: 6px; font-weight: bold; }
    .bullet-buy { color: #2EAADC; } .bullet-sell { color: #E03E3E; }
    .empty-msg { font-size: 0.8rem; color: #CCC; font-style: italic; }

    /* íƒœê·¸ */
    .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
    .tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; color: #444; }
    /* íƒœê·¸ ìƒ‰ìƒë“¤ */
    .tag-gray { background: #E3E2E0; } .tag-yellow { background: #FDECC8; } .tag-green { background: #DBEDDB; }
    .tag-blue { background: #D3E5EF; } .tag-red { background: #FFE2DD; } .tag-purple { background: #E8DEEE; } .tag-orange { background: #FADEC9; }

    .add-btn { padding: 12px; color: var(--gray); cursor: pointer; border-radius: 6px; margin-top: 5px;margin-bottom: 5px; display: flex; align-items: center; }
    .add-btn:hover { background: rgba(0,0,0,0.05); color: #333; }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
    .form-textarea { resize: vertical; min-height: 80px; }

    .color-picker { display: flex; gap: 8px; margin-bottom: 10px; }
    .color-opt { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-opt.selected { border-color: #333; transform: scale(1.1); }

    .rec-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .rec-tag-btn { border: none; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; color: #333; position: relative; }
    .rec-tag-btn:hover .edit-hint { display: block; }
    .edit-hint { display: none; position: absolute; top: -20px; left: 0; background: #333; color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px; white-space: nowrap;}

    .btn-submit { background: #333; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-edit { flex: 1; background: #333; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-delete { width: 80px; background: white; color: #E03E3E; border: 1px solid #E03E3E; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

<div class="mobile-tabs">
  <button class="tab-btn active" onclick="switchTab('ALL', this)">ì „ì²´</button>
  <button class="tab-btn" onclick="switchTab('DOM', this)">ğŸ‡°ğŸ‡· êµ­ì¥</button>
  <button class="tab-btn" onclick="switchTab('OVS', this)">ğŸ‡ºğŸ‡¸ ë¯¸ì¥</button>
</div>

<div class="main-container">
  <div id="col-dom" class="column col-dom show">
    <div class="header">
      <div class="badge badge-dom">êµ­ì¥ ì „ëµ <span style="margin-left:5px; opacity:0.6" th:text="${#lists.size(stocks.?[marketType.name() == 'DOMESTIC'])}"></span></div>
    </div>
    <div class="card" th:each="stock : ${stocks}" th:if="${stock.marketType.name() == 'DOMESTIC'}" th:onclick="openDetailModal([[${stock}]])">
      <div class="card-top"><div><span class="stock-name" th:text="${stock.stockName}"></span><span class="stock-code" th:text="${stock.code}"></span></div></div>

      <ul class="strategy-list">
        <li class="strategy-item" th:each="str, stat : ${stock.buyStrategies}" th:if="${stat.index < 2}">
          <span class="bullet bullet-buy">â€¢</span> <span th:text="${str}"></span>
        </li>
        <li class="strategy-item" th:each="str, stat : ${stock.sellStrategies}" th:if="${stat.index < 2}">
          <span class="bullet bullet-sell">â€¢</span> <span th:text="${str}"></span>
        </li>
      </ul>

      <div class="tags">
                <span th:each="t : ${stock.tags}" th:with="p=${#strings.arraySplit(t, '|')}"
                      class="tag" th:classappend="'tag-'+${p.length>1?p[1]:'gray'}" th:text="${p[0]}"></span>
      </div>
    </div>
    <div class="add-btn" onclick="openCreateModal('DOMESTIC')"><span>+ ìƒˆë¡œ ë§Œë“¤ê¸°</span></div>
  </div>

  <div id="col-ovs" class="column col-ovs show">
    <div class="header">
      <div class="badge badge-ovs">ë¯¸ì¥ ì „ëµ <span style="margin-left:5px; opacity:0.6" th:text="${#lists.size(stocks.?[marketType.name() == 'OVERSEAS'])}"></span></div>
    </div>
    <div class="card" th:each="stock : ${stocks}" th:if="${stock.marketType.name() == 'OVERSEAS'}" th:onclick="openDetailModal([[${stock}]])">
      <div class="card-top"><div><span class="stock-name" th:text="${stock.stockName}"></span><span class="stock-code" th:text="${stock.code}"></span></div></div>

      <ul class="strategy-list">
        <li class="strategy-item" th:each="str, stat : ${stock.buyStrategies}" th:if="${stat.index < 2}">
          <span class="bullet bullet-buy">â€¢</span> <span th:text="${str}"></span>
        </li>
        <li class="strategy-item" th:each="str, stat : ${stock.sellStrategies}" th:if="${stat.index < 2}">
          <span class="bullet bullet-sell">â€¢</span> <span th:text="${str}"></span>
        </li>
      </ul>

      <div class="tags">
                <span th:each="t : ${stock.tags}" th:with="p=${#strings.arraySplit(t, '|')}"
                      class="tag" th:classappend="'tag-'+${p.length>1?p[1]:'gray'}" th:text="${p[0]}"></span>
      </div>
    </div>
    <div class="add-btn" onclick="openCreateModal('OVERSEAS')"><span>+ ìƒˆë¡œ ë§Œë“¤ê¸°</span></div>
  </div>
</div>

<div id="createModal" class="modal-overlay" onclick="closeModal(event, 'createModal')">
  <div class="modal-box">
    <h3 id="modalTitle" style="margin-top:0;">ì „ëµ ìˆ˜ì •</h3>
    <input type="hidden" id="inputId">
    <select id="inputMarket" class="form-select">
      <option value="DOMESTIC">ğŸ‡°ğŸ‡· êµ­ì¥</option><option value="OVERSEAS">ğŸ‡ºğŸ‡¸ ë¯¸ì¥</option>
    </select>
    <input type="text" id="inputName" class="form-input" placeholder="ì¢…ëª©ëª…">
    <input type="text" id="inputCode" class="form-input" placeholder="í‹°ì»¤ (CODE)">

    <label style="color:#2EAADC; font-size:0.9rem; font-weight:bold;">ğŸš€ ë§¤ìˆ˜ ì „ëµ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
    <textarea id="inputBuy" class="form-textarea" placeholder="â€¢ 20ì¼ì„  í„°ì¹˜ ì‹œ&#13;&#10;â€¢ RSI 30 ì´í•˜"></textarea>

    <label style="color:#E03E3E; font-size:0.9rem; font-weight:bold;">ğŸ’° ë§¤ë„ ì „ëµ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
    <textarea id="inputSell" class="form-textarea" placeholder="â€¢ 5% ìˆ˜ìµ ì‹œ ì ˆë°˜ ìµì ˆ&#13;&#10;â€¢ ì „ê³ ì  ë„ë‹¬"></textarea>

    <label style="font-size:0.9rem; font-weight:bold;">íƒœê·¸</label>
    <div style="display:flex; gap:5px; margin-bottom:5px;">
      <input type="text" id="inputTagText" class="form-input" placeholder="íƒœê·¸ ì´ë¦„" style="margin-bottom:0;">
      <button onclick="addTagFromInput()" style="width:60px; border-radius:5px; border:1px solid #ddd;">ì¶”ê°€</button>
    </div>
    <div class="color-picker">
      <div class="color-opt selected" style="background:#E3E2E0" onclick="selColor(this, 'gray')"></div>
      <div class="color-opt" style="background:#FDECC8" onclick="selColor(this, 'yellow')"></div>
      <div class="color-opt" style="background:#DBEDDB" onclick="selColor(this, 'green')"></div>
      <div class="color-opt" style="background:#D3E5EF" onclick="selColor(this, 'blue')"></div>
      <div class="color-opt" style="background:#FFE2DD" onclick="selColor(this, 'red')"></div>
      <div class="color-opt" style="background:#E8DEEE" onclick="selColor(this, 'purple')"></div>
    </div>
    <div id="curTags" style="display:flex; gap:5px; flex-wrap:wrap; min-height:30px; margin-bottom:10px;"></div>

    <div style="font-size:0.8rem; color:#888; border-top:1px solid #eee; padding-top:10px;">
      ê¸°ì¡´ íƒœê·¸ (ë”ë¸”í´ë¦­í•˜ì—¬ ìˆ˜ì •)
    </div>
    <div class="rec-tags">
      <button th:each="fullTag : ${allTags}" th:with="parts=${#strings.arraySplit(fullTag, '|')}"
              class="rec-tag-btn" th:style="'background:var(--tag-'+${parts[1]}+')'"
              th:onclick="addRecTag([[${parts[0]}]], [[${parts[1]}]])"
              th:ondblclick="editTagName([[${parts[0]}]])"> <span th:text="${parts[0]}"></span>
        <span class="edit-hint">ìˆ˜ì •</span>
      </button>
    </div>

    <button class="btn-submit" onclick="saveStock()">ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="closeModal(event, 'detailModal')">
  <div class="modal-box">
    <h2 id="detName" style="margin:0;"></h2>
    <div id="detTags" style="display:flex; gap:5px; margin:10px 0;"></div>

    <h4 style="color:#2EAADC; margin-bottom:5px;">ğŸš€ ë§¤ìˆ˜ ì „ëµ</h4>
    <ul id="detBuy" class="strategy-list"></ul>

    <h4 style="color:#E03E3E; margin-bottom:5px; margin-top:20px;">ğŸ’° ë§¤ë„ ì „ëµ</h4>
    <ul id="detSell" class="strategy-list"></ul>

    <div class="modal-actions">
      <button class="btn-delete" onclick="deleteStock()">ì‚­ì œ</button>
      <button class="btn-edit" onclick="editStock()">ìˆ˜ì •</button>
    </div>
  </div>
</div>

<script>
  let curTags = [], selCol = 'gray', curStock = null;

  function switchTab(type, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    const dom = document.getElementById('col-dom'), ovs = document.getElementById('col-ovs');
    if(type==='ALL'){ dom.classList.add('show'); ovs.classList.add('show'); }
    else if(type==='DOM'){ dom.classList.add('show'); ovs.classList.remove('show'); }
    else { dom.classList.remove('show'); ovs.classList.add('show'); }
  }

  function openCreateModal(type) {
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = "ì „ëµì¶”ê°€";
    document.getElementById('inputId').value = '';
    document.getElementById('inputMarket').value = type;
    document.getElementById('inputName').value = '';
    document.getElementById('inputCode').value = '';
    document.getElementById('inputBuy').value = ''; // í…ìŠ¤íŠ¸area ì´ˆê¸°í™”
    document.getElementById('inputSell').value = '';
    curTags = []; renderTags();
  }

  function openDetailModal(stock) {
    curStock = stock;
    document.getElementById('detailModal').style.display = 'flex';
    document.getElementById('detName').innerText = stock.stockName;

    // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ë§¤ìˆ˜)
    const buyUl = document.getElementById('detBuy'); buyUl.innerHTML = '';
    if(stock.buyStrategies.length === 0) buyUl.innerHTML = '<li class="empty-msg">ì „ëµ ì—†ìŒ</li>';
    stock.buyStrategies.forEach(s => buyUl.innerHTML += `<li class="strategy-item"><span class="bullet bullet-buy">â€¢</span> ${s}</li>`);

    // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ë§¤ë„)
    const sellUl = document.getElementById('detSell'); sellUl.innerHTML = '';
    if(stock.sellStrategies.length === 0) sellUl.innerHTML = '<li class="empty-msg">ì „ëµ ì—†ìŒ</li>';
    stock.sellStrategies.forEach(s => sellUl.innerHTML += `<li class="strategy-item"><span class="bullet bullet-sell">â€¢</span> ${s}</li>`);

    // íƒœê·¸
    const tagBox = document.getElementById('detTags'); tagBox.innerHTML = '';
    stock.tags.forEach(t => {
      let p = t.split('|');
      tagBox.innerHTML += `<span class="tag tag-${p[1]||'gray'}">${p[0]}</span>`;
    });
  }

  function editStock() {
    if(!curStock) return;
    document.getElementById('detailModal').style.display = 'none';
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = "ìˆ˜ì •í•˜ê¸°";

    document.getElementById('inputId').value = curStock.id;
    document.getElementById('inputMarket').value = curStock.marketType;
    document.getElementById('inputName').value = curStock.stockName;
    document.getElementById('inputCode').value = curStock.code;

    // â­ ë¦¬ìŠ¤íŠ¸ -> ì¤„ë°”ê¿ˆ ë¬¸ìì—´ë¡œ ë³€í™˜í•´ì„œ í…ìŠ¤íŠ¸ì°½ì— ë„£ê¸°
    document.getElementById('inputBuy').value = curStock.buyStrategies.join('\n');
    document.getElementById('inputSell').value = curStock.sellStrategies.join('\n');

    curTags = [...curStock.tags]; renderTags();
  }

  function saveStock() {
    const id = document.getElementById('inputId').value;
    const buyText = document.getElementById('inputBuy').value;
    const sellText = document.getElementById('inputSell').value;

    // â­ ì¤„ë°”ê¿ˆ(\n) ê¸°ì¤€ìœ¼ë¡œ ìª¼ê°œì„œ ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“¦ (ë¹ˆ ì¤„ì€ ì œê±°)
    const buyList = buyText.split('\n').map(s=>s.trim()).filter(s=>s!=='');
    const sellList = sellText.split('\n').map(s=>s.trim()).filter(s=>s!=='');

    const data = {
      id: id ? parseInt(id) : null,
      stockName: document.getElementById('inputName').value,
      code: document.getElementById('inputCode').value,
      marketType: document.getElementById('inputMarket').value,
      buyStrategies: buyList,  // ë¦¬ìŠ¤íŠ¸ ì „ì†¡
      sellStrategies: sellList, // ë¦¬ìŠ¤íŠ¸ ì „ì†¡
      tags: curTags
    };
    fetch('/api/stocks', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) })
            .then(r=>{ if(r.ok) location.reload(); else alert('ì‹¤íŒ¨'); });
  }

  function deleteStock() {
    if(!curStock || !confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    fetch('/api/stocks/'+curStock.id, { method:'DELETE' }).then(r=> location.reload());
  }

  // íƒœê·¸ ê´€ë ¨
  function selColor(el, c) {
    document.querySelectorAll('.color-opt').forEach(o=>o.classList.remove('selected'));
    el.classList.add('selected'); selCol = c;
  }
  function addTagFromInput() {
    let val = document.getElementById('inputTagText').value.trim();
    if(val) {
      let full = val + '|' + selCol;
      if(!curTags.includes(full)) curTags.push(full);
      renderTags();
      document.getElementById('inputTagText').value = '';
    }
  }
  function addRecTag(name, color) {
    let full = name + '|' + color;
    if(!curTags.includes(full)) curTags.push(full);
    renderTags();
  }
  function renderTags() {
    const box = document.getElementById('curTags'); box.innerHTML = '';
    curTags.forEach((t, i) => {
      let p = t.split('|');
      let s = document.createElement('span');
      s.className = `tag tag-${p[1]||'gray'}`; s.innerText = p[0] + ' âœ•'; s.style.cursor='pointer';
      s.onclick = ()=> { curTags.splice(i,1); renderTags(); };
      box.appendChild(s);
    });
  }

  // â­ íƒœê·¸ ì´ë¦„ ìˆ˜ì • ê¸°ëŠ¥
  function editTagName(oldName) {
    const newName = prompt(`'${oldName}' íƒœê·¸ ì´ë¦„ì„ ë¬´ì—‡ìœ¼ë¡œ ë°”ê¿€ê¹Œìš”?`);
    if (newName && newName.trim() !== "" && newName !== oldName) {
      fetch('/api/stocks/tags', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ oldName: oldName, newName: newName.trim() })
      }).then(r => {
        if(r.ok) { alert('ë³€ê²½ ì™„ë£Œ!'); location.reload(); }
        else alert('ë³€ê²½ ì‹¤íŒ¨');
      });
    }
  }

  function closeModal(e, id) { if(e.target === document.getElementById(id)) document.getElementById(id).style.display='none'; }
</script>
</body>
</html>