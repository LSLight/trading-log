<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ì‹ ì‚¬íŒ”ì‚¬íŒ”</title>
  <style>
    :root {
      --bg-color: #FFFFFF; --text-color: #37352F; --gray-text: #9B9A97;
      --dom-col-bg: #F7F6F3; --ovs-col-bg: #F0FDF4;
      --badge-gray-bg: #E3E2E0; --badge-green-bg: #DBEDDB;
      /* íƒœê·¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
      --tag-gray: #E3E2E0; --tag-brown: #EEE0DA; --tag-orange: #FADEC9;
      --tag-yellow: #FDECC8; --tag-green: #DBEDDB; --tag-blue: #D3E5EF;
      --tag-purple: #E8DEEE; --tag-pink: #F5E0E9; --tag-red: #FFE2DD;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-color); color: var(--text-color);
      margin: 0; padding: 20px; overflow-y: scroll;
    }

    /* ğŸ“± ëª¨ë°”ì¼ íƒ­ */
    .mobile-tabs { display: none; margin-bottom: 15px; gap: 10px; border-bottom: 1px solid #E9E9E7; padding-bottom: 10px; }
    .tab-btn { background: none; border: none; font-size: 0.95rem; color: var(--gray-text); cursor: pointer; padding: 5px 8px; }
    .tab-btn.active { color: var(--text-color); font-weight: 600; border-bottom: 2px solid var(--text-color); }

    /* ğŸ–¥ï¸ ë³´ë“œ ì»¨í…Œì´ë„ˆ */
    .board-container { display: flex; align-items: flex-start; gap: 16px; overflow-x: auto; padding-bottom: 20px; min-height: 80vh; }
    .column { flex: 0 0 280px; display: flex; flex-direction: column; border-radius: 6px; padding: 12px 10px; }
    #col-dom { background-color: var(--dom-col-bg); }
    #col-ovs { background-color: var(--ovs-col-bg); }

    .column-header { display: flex; align-items: center; margin-bottom: 10px; padding: 0 4px; height: 24px; }
    .header-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500; }
    .badge-dom { background: var(--badge-gray-bg); color: #32302C; }
    .badge-ovs { background: var(--badge-green-bg); color: #1C3829; }
    .count { margin-left: 6px; color: var(--gray-text); font-size: 0.8rem; }

    /* ğŸƒ ì¹´ë“œ */
    .card {
      background: white; border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); padding: 12px; margin-bottom: 8px;
      cursor: pointer; position: relative;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
    .stock-title { font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; flex: 1; }
    .stock-icon { margin-right: 6px; font-size: 1rem; }

    .card-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
    .card:hover .card-actions { opacity: 1; }
    .action-btn { font-size: 0.8rem; padding: 2px 4px; border-radius: 3px; cursor: pointer; color: #888; background: rgba(0,0,0,0.05); border: none; }
    .action-btn:hover { background: #E0E0E0; color: #333; }
    .btn-del:hover { background: #FFE2DD; color: #D44C47; }

    /* ì „ëµ ë©ì–´ë¦¬ ì „ì²´ ë°•ìŠ¤ */
    .strategy-block {
      margin-bottom: 10px; /* ë¸”ë¡ ê°„ì˜ ê°„ê²©ë„ ì•½ê°„ ì¤„ì„ */
      font-size: 0.8rem;
      color: #37352F;
    }

    /* <ë§¤ìˆ˜>, <ë§¤ë„> ë¼ë²¨ */
    .strategy-label {
      color: var(--gray-text);
      font-size: 0.75rem;
      font-weight: 500;
      display: block;
      line-height: 1; /* ë†’ì´ ìµœì†Œí™” */
      margin-bottom: 2px !important; /* ì•„ë˜ ë‚´ìš©ê³¼ ê±°ì˜ ë¶™ê²Œ ì„¤ì • */
    }

    /* ì „ëµ í•œ ì¤„ í•œ ì¤„ (div) */
    .strategy-line {
      margin: 0 !important; /* ìœ„ì•„ë˜ ëª¨ë“  ì—¬ë°± ê°•ì œ ì œê±° */
      padding: 0 !important;
      padding-left: 4px !important;
      line-height: 1.25 !important; /* ì¤„ ê°„ê²© ì••ì¶• */
      display: block;
      word-break: break-all;
      white-space: pre-wrap;
    }

    /* ì „ëµ ë‚´ìš©ë“¤ ì‚¬ì´ê°€ ë²Œì–´ì§€ëŠ” ê±¸ ë§‰ê¸° ìœ„í•´ ë¶€ëª¨ ë°•ìŠ¤ ì—¬ë°± ì¡°ì • */
    .strategy-block div + div {
      margin-top: 1px !important; /* ì¤„ ì‚¬ì´ ê°„ê²©ì„ ë”± 1pxë§Œ ìœ ì§€ */
    }

    /* â­ íƒœê·¸ ìƒ‰ìƒ í´ë˜ìŠ¤ (ë¹ ì§„ ìƒ‰ìƒ ì¶”ê°€ë¨!) */
    .tags { display: flex; flex-wrap: wrap; gap: 4px;}
    .tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; color: #444; }
    .tag-gray { background: var(--tag-gray); }
    .tag-brown { background: var(--tag-brown); }
    .tag-orange { background: var(--tag-orange); }
    .tag-yellow { background: var(--tag-yellow); }
    .tag-green { background: var(--tag-green); }
    .tag-blue { background: var(--tag-blue); }
    .tag-purple { background: var(--tag-purple); }
    .tag-pink { background: var(--tag-pink); }
    .tag-red { background: var(--tag-red); }

    .btn-new-page { display: flex; align-items: center; color: var(--gray-text); padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-top: 4px; }
    .btn-new-page:hover { background: rgba(0,0,0,0.05); color: var(--text-color); }
    .btn-new-page span { margin-right: 8px; font-size: 1.1rem; font-weight: 300; }

    @media (max-width: 768px) {
      .mobile-tabs { display: flex; }
      .board-container { gap: 20px; scroll-snap-type: x mandatory; }
      .column { flex: 0 0 85vw; scroll-snap-align: start; }
      .column.hidden { display: none; }
      .column.active { display: flex; flex: 0 0 100%; }
      .card-actions { opacity: 1; }
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 92%; max-width: 500px; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .form-input, .form-textarea, .form-select { width: 100%; padding: 8px 0; border: none; border-bottom: 1px solid #E0E0E0; margin-bottom: 15px; font-size: 0.95rem; outline: none; font-family: inherit;}
    .form-input:focus, .form-textarea:focus { border-bottom: 1px solid #333; }
    .form-textarea { resize: none; min-height: 80px; }
    .btn-submit { background: #333; color: white; width: 100%; padding: 10px; border-radius: 4px; border: none; cursor: pointer; margin-top: 10px; }

    .rec-tags-area { margin-top: 20px; padding-top: 15px; border-top: 1px solid #F0F0F0; }
    .rec-tag-btn { background: #F0F0F0; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin: 2px; cursor: pointer; color: #555; }

    .color-picker { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
    .color-opt { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;}
    .color-opt:hover { transform: scale(1.1); }
    .color-opt.selected { border: 2px solid #333; transform: scale(1.1); }
  </style>
</head>
<body>

<div class="mobile-tabs">
  <button class="tab-btn active" onclick="showColumn('ALL', this)">ì „ì²´ ë³´ê¸°</button>
  <button class="tab-btn" onclick="showColumn('DOM', this)">ğŸ‡°ğŸ‡· êµ­ì¥</button>
  <button class="tab-btn" onclick="showColumn('OVS', this)">ğŸ‡ºğŸ‡¸ ë¯¸ì¥</button>
</div>

<div class="board-container">

  <div id="col-dom" class="column">
    <div class="column-header">
      <div class="header-badge badge-dom">êµ­ì¥ ì „ëµ <span class="count" th:text="${#lists.size(stocks.?[marketType.name() == 'DOMESTIC'])}">0</span></div>
    </div>

    <div class="card" th:each="stock : ${stocks}" th:if="${stock.marketType.name() == 'DOMESTIC'}" onclick="openDetailModal(this)" th:data-stock="${stock.id}">
      <div class="card-header">
        <div class="stock-title"><span class="stock-icon">ğŸ‡°ğŸ‡·</span><span th:text="${stock.stockName}"></span></div>
        <div class="card-actions">
          <button class="action-btn" onclick="editStockDirect(event, this)">âœï¸</button>
          <button class="action-btn btn-del" onclick="deleteStockDirect(event, [[${stock.id}]])">ğŸ—‘ï¸</button>
        </div>
      </div>

      <div class="strategy-block buy-area" th:if="${not #lists.isEmpty(stock.buyStrategies)}">
        <span class="strategy-label">&lt;ë§¤ìˆ˜&gt;</span>
        <div class="strategy-line" th:each="st : ${stock.buyStrategies}" th:text="${st}"></div>
      </div>
      <div class="strategy-block sell-area" th:if="${not #lists.isEmpty(stock.sellStrategies)}">
        <span class="strategy-label">&lt;ë§¤ë„&gt;</span>
        <div class="strategy-line" th:each="st : ${stock.sellStrategies}" th:text="${st}"></div>
      </div>

      <div class="tags">
                    <span th:each="t : ${stock.tags}" th:with="p=${#strings.arraySplit(t, '|')}"
                          class="tag" th:classappend="'tag-'+${p.length>1?p[1]:'gray'}" th:text="${p[0]}"></span>
      </div>
    </div>
    <div class="btn-new-page" onclick="openCreateModal('DOMESTIC')"><span>+</span> ìƒˆ í˜ì´ì§€</div>
  </div>

  <div id="col-ovs" class="column">
    <div class="column-header">
      <div class="header-badge badge-ovs">ë¯¸ì¥ ì „ëµ <span class="count" th:text="${#lists.size(stocks.?[marketType.name() == 'OVERSEAS'])}">0</span></div>
    </div>

    <div class="card" th:each="stock : ${stocks}" th:if="${stock.marketType.name() == 'OVERSEAS'}" onclick="openDetailModal(this)" th:data-stock="${stock.id}">
      <div class="card-header">
        <div class="stock-title"><span class="stock-icon">ğŸ‡ºğŸ‡¸</span><span th:text="${stock.stockName}"></span></div>
        <div class="card-actions">
          <button class="action-btn" onclick="editStockDirect(event, this)">âœï¸</button>
          <button class="action-btn btn-del" onclick="deleteStockDirect(event, [[${stock.id}]])">ğŸ—‘ï¸</button>
        </div>
      </div>

      <div class="strategy-block buy-area" th:if="${not #lists.isEmpty(stock.buyStrategies)}">
        <span class="strategy-label">&lt;ë§¤ìˆ˜&gt;</span>
        <div class="strategy-line" th:each="st : ${stock.buyStrategies}" th:text="${st}"></div>
      </div>
      <div class="strategy-block sell-area" th:if="${not #lists.isEmpty(stock.sellStrategies)}">
        <span class="strategy-label">&lt;ë§¤ë„&gt;</span>
        <div class="strategy-line" th:each="st : ${stock.sellStrategies}" th:text="${st}"></div>
      </div>

      <div class="tags">
                    <span th:each="t : ${stock.tags}" th:with="p=${#strings.arraySplit(t, '|')}"
                          class="tag" th:classappend="'tag-'+${p.length>1?p[1]:'gray'}" th:text="${p[0]}"></span>
      </div>
    </div>
    <div class="btn-new-page" onclick="openCreateModal('OVERSEAS')"><span>+</span> ìƒˆ í˜ì´ì§€</div>
  </div>
</div>

<div id="createModal" class="modal-overlay" onclick="closeModal(event, 'createModal')">
  <div class="modal-box">
    <h3 id="modalTitle" style="margin-top:0; font-weight:600;">í˜ì´ì§€ ì¶”ê°€</h3>
    <input type="hidden" id="inputId">
    <select id="inputMarket" class="form-select">
      <option value="DOMESTIC">êµ­ì¥</option><option value="OVERSEAS">ë¯¸ì¥</option>
    </select>
    <input type="text" id="inputName" class="form-input" placeholder="ì œëª© (ì¢…ëª©ëª…)">
    <input type="text" id="inputCode" class="form-input" placeholder="ì½”ë“œ (ì„ íƒì‚¬í•­)">

    <label style="font-size:0.85rem; color:#888;">ë§¤ìˆ˜ ì „ëµ (ì—”í„°ë¡œ ì¤„ë°”ê¿ˆ)</label>
    <textarea id="inputBuy" class="form-textarea" placeholder="ì „ëµ ì…ë ¥..."></textarea>

    <label style="font-size:0.85rem; color:#888;">ë§¤ë„ ì „ëµ</label>
    <textarea id="inputSell" class="form-textarea" placeholder="ì „ëµ ì…ë ¥..."></textarea>

    <div style="margin-top:10px;">
      <input type="text" id="inputTagText" class="form-input" placeholder="íƒœê·¸ ì…ë ¥" style="width:70%; display:inline-block;">
      <button onclick="addTagFromInput()" style="width:25%; padding:8px; border:1px solid #ddd; background:white; border-radius:4px;">ì¶”ê°€</button>
    </div>

    <div class="color-picker">
      <div class="color-opt selected" style="background:#E3E2E0" onclick="selColor(this, 'gray')" title="íšŒìƒ‰"></div>
      <div class="color-opt" style="background:#EEE0DA" onclick="selColor(this, 'brown')" title="ê°ˆìƒ‰"></div>
      <div class="color-opt" style="background:#FADEC9" onclick="selColor(this, 'orange')" title="ì£¼í™©ìƒ‰"></div>
      <div class="color-opt" style="background:#FDECC8" onclick="selColor(this, 'yellow')" title="ë…¸ë€ìƒ‰"></div>
      <div class="color-opt" style="background:#DBEDDB" onclick="selColor(this, 'green')" title="ì´ˆë¡ìƒ‰"></div>
      <div class="color-opt" style="background:#D3E5EF" onclick="selColor(this, 'blue')" title="íŒŒë€ìƒ‰"></div>
      <div class="color-opt" style="background:#E8DEEE" onclick="selColor(this, 'purple')" title="ë³´ë¼ìƒ‰"></div>
      <div class="color-opt" style="background:#F5E0E9" onclick="selColor(this, 'pink')" title="ë¶„í™ìƒ‰"></div>
      <div class="color-opt" style="background:#FFE2DD" onclick="selColor(this, 'red')" title="ë¹¨ê°„ìƒ‰"></div>
    </div>

    <div id="curTags" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div>

    <div class="rec-tags-area">
      <div style="font-size:0.8rem; color:#999; margin-bottom:8px;">ğŸ·ï¸ ê¸°ì¡´ íƒœê·¸ ì„ íƒ</div>
      <button th:each="fullTag : ${allTags}" th:with="parts=${#strings.arraySplit(fullTag, '|')}"
              class="rec-tag-btn" th:onclick="addTagFromRec([[${parts[0]}]], [[${parts[1]}]])">
        <span th:text="${parts[0]}">íƒœê·¸ëª…</span>
      </button>
    </div>
    <button class="btn-submit" onclick="saveStock()">ì™„ë£Œ</button>
  </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="closeModal(event, 'detailModal')">
  <div class="modal-box">
    <div style="font-size:1.5rem; font-weight:700; margin-bottom:10px;" id="detName"></div>
    <div id="detTags" style="display:flex; gap:5px; margin-bottom:20px;"></div>
    <div style="background:#F7F7F5; padding:15px; border-radius:4px; margin-bottom:10px;">
      <div style="font-size:0.85rem; color:#888;">ë§¤ìˆ˜ ì „ëµ</div>
      <div id="detBuy" style="white-space: pre-wrap; font-size:0.95rem;"></div>
    </div>
    <div style="background:#F7F7F5; padding:15px; border-radius:4px;">
      <div style="font-size:0.85rem; color:#888;">ë§¤ë„ ì „ëµ</div>
      <div id="detSell" style="white-space: pre-wrap; font-size:0.95rem;"></div>
    </div>
  </div>
</div>

<script>
  let curTags=[], selCol='gray';

  function showColumn(type, btn) {
    if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    const dom = document.getElementById('col-dom'), ovs = document.getElementById('col-ovs');
    if(window.innerWidth <= 768) {
      if(type==='ALL'){ dom.classList.remove('hidden','active'); ovs.classList.remove('hidden','active'); }
      else if(type==='DOM'){ dom.classList.remove('hidden'); dom.classList.add('active'); ovs.classList.add('hidden'); ovs.classList.remove('active'); }
      else { dom.classList.add('hidden'); dom.classList.remove('active'); ovs.classList.remove('hidden'); ovs.classList.add('active'); }
    }
  }

  function openCreateModal(type) {
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = "í˜ì´ì§€ ì¶”ê°€";
    document.getElementById('inputId').value = '';
    document.getElementById('inputMarket').value = type;
    document.getElementById('inputName').value = '';
    document.getElementById('inputCode').value = '';
    document.getElementById('inputBuy').value = '';
    document.getElementById('inputSell').value = '';
    curTags = []; renderTags();
  }

  function openDetailModal(cardEl) {
    const name = cardEl.querySelector('.stock-title span:last-child').innerText;
    const tagsHtml = cardEl.querySelector('.tags').innerHTML;
    document.getElementById('detailModal').style.display = 'flex';
    document.getElementById('detName').innerText = name;
    let buyText = ""; if(cardEl.querySelector('.buy-area')) { cardEl.querySelectorAll('.buy-area .strategy-line').forEach(d => buyText += d.innerText + "\n"); }
    let sellText = ""; if(cardEl.querySelector('.sell-area')) { cardEl.querySelectorAll('.sell-area .strategy-line').forEach(d => sellText += d.innerText + "\n"); }
    document.getElementById('detBuy').innerText = buyText;
    document.getElementById('detSell').innerText = sellText;
    document.getElementById('detTags').innerHTML = tagsHtml;
  }

  function editStockDirect(event, btn) {
    event.stopPropagation();
    const card = btn.closest('.card');
    const name = card.querySelector('.stock-title span:last-child').innerText;
    const id = card.getAttribute('data-stock');

    let buyText = ""; if(card.querySelector('.buy-area')) { card.querySelectorAll('.buy-area .strategy-line').forEach(d => buyText += d.innerText + "\n"); }
    let sellText = ""; if(card.querySelector('.sell-area')) { card.querySelectorAll('.sell-area .strategy-line').forEach(d => sellText += d.innerText + "\n"); }

    curTags = [];
    card.querySelectorAll('.tags .tag').forEach(tag => {
      const text = tag.innerText;
      let color = 'gray';
      tag.classList.forEach(cls => { if(cls.startsWith('tag-')) color = cls.replace('tag-',''); });
      curTags.push(text + '|' + color);
    });

    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = "í˜ì´ì§€ ìˆ˜ì •";
    document.getElementById('inputId').value = id;
    document.getElementById('inputName').value = name;
    document.getElementById('inputBuy').value = buyText;
    document.getElementById('inputSell').value = sellText;
    renderTags();
  }

  function deleteStockDirect(event, id) {
    event.stopPropagation();
    if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      fetch('/api/stocks/' + id, { method: 'DELETE' }).then(r => location.reload());
    }
  }

  function saveStock() {
    const data = {
      id: document.getElementById('inputId').value || null,
      stockName: document.getElementById('inputName').value,
      code: document.getElementById('inputCode').value,
      marketType: document.getElementById('inputMarket').value,
      buyStrategies: document.getElementById('inputBuy').value.split('\n').filter(s=>s.trim()),
      sellStrategies: document.getElementById('inputSell').value.split('\n').filter(s=>s.trim()),
      tags: curTags
    };
    fetch('/api/stocks', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }).then(r=>{ if(r.ok) location.reload(); });
  }

  function closeModal(e, id) { if(e.target === document.getElementById(id)) document.getElementById(id).style.display='none'; }
  function selColor(el, c) { document.querySelectorAll('.color-opt').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); selCol = c; }
  function addTagFromInput() { let v = document.getElementById('inputTagText').value; if(v) { curTags.push(v+'|'+selCol); renderTags(); document.getElementById('inputTagText').value=''; } }
  function addTagFromRec(n, c) { curTags.push(n+'|'+c); renderTags(); }
  function renderTags() { const b = document.getElementById('curTags'); b.innerHTML=''; curTags.forEach((t,i)=>{ let p=t.split('|'); b.innerHTML+=`<span class="tag tag-${p[1]||'gray'}" onclick="curTags.splice(${i},1);renderTags()" style="cursor:pointer">${p[0]} âœ•</span>`; }); }
</script>
</body>
</html>